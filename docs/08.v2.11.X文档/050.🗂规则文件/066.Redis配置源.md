---
title: ğŸ“‘Redisé…ç½®æº
date: 2023-08-23 19:55:26
permalink: /pages/186747/
---

LiteFlowä»v2.11.0å¼€å§‹ï¼ŒåŸç”Ÿæ”¯æŒäº†Redisçš„è§„åˆ™é…ç½®æºã€‚

## ä¾èµ–

å¦‚æœä½¿ç”¨Redisä½œä¸ºè§„åˆ™é…ç½®æºï¼Œä½ éœ€è¦æ·»åŠ ä»¥ä¸‹é¢å¤–æ’ä»¶ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.yomahub</groupId>
    <artifactId>liteflow-rule-redis</artifactId>
    <version>2.11.0</version>
</dependency>
```

## é…ç½®æ¨¡å¼

Redisé…ç½®æºæ”¯æŒå¹³æ»‘çƒ­åˆ·æ–°ï¼Œåœ¨åˆ·æ–°æœºåˆ¶ä¸Šå®ç°äº†ã€**è½®è¯¢**ã€‘å’Œã€**è®¢é˜…**ã€‘ä¸¤ç§æ¨¡å¼ï¼Œå¯ä¾æ®éœ€è¦é€‰æ‹©ã€‚

>ã€**è½®è¯¢æ¨¡å¼**ã€‘ï¼šåŸºäºRedisçš„Hashç»“æ„ï¼Œé€šè¿‡å®šæ—¶è½®è¯¢çš„æ–¹å¼è¿›è¡Œè§„åˆ™åˆ·æ–°ï¼Œè½®è¯¢é¢‘ç‡å¯é…ç½®ï¼Œè½®è¯¢é—´éš”å†…æœ‰ä¸€å®šåˆ·æ–°å»¶è¿Ÿã€‚
>
>ã€**è®¢é˜…æ¨¡å¼**ã€‘ï¼šä¾èµ–äºRedissonå®¢æˆ·ç«¯çš„RMapCacheå­˜å‚¨ç»“æ„ï¼Œåªæ”¯æŒå°†è§„åˆ™æ•°æ®å­˜å‚¨åœ¨ç‹¬æœ‰çš„RMapCacheç»“æ„ä¸­ï¼›å¯å®ç°è§„åˆ™çš„å®æ—¶å¹³æ»‘åˆ·æ–°ã€‚

ä¸¤ç§æ¨¡å¼çš„æ’ä»¶ä¾èµ–ç›¸åŒï¼Œä»…é€šè¿‡é…ç½®å‚æ•°åŠ ä»¥åŒºåˆ†ã€‚

å¦‚æœæ²¡æœ‰é…ç½®modeå‚æ•°ï¼Œé»˜è®¤é€‰æ‹©ä¸ºè½®è¯¢æ¨¡å¼ã€‚



## é…ç½®

ä¾èµ–äº†æ’ä»¶åŒ…ä¹‹åï¼Œä½ æ— éœ€å†é…ç½®`liteflow.ruleSource`è·¯å¾„ã€‚

åªéœ€è¦é…ç½®æ’ä»¶çš„é¢å¤–å‚æ•°å³å¯ã€‚

Redisé…ç½®æºæ”¯æŒå•ç‚¹å’Œå“¨å…µæ¨¡å¼ï¼Œåœ¨è½®è¯¢å’Œè®¢é˜…ä¸¤ç§æœºåˆ¶ä¸‹é…ç½®åˆ†åˆ«å¦‚ä¸‹ï¼š


### è½®è¯¢æ¨¡å¼

<code-group>
  <code-block title="Yamlé£æ ¼é…ç½®" active>

```yaml
liteflow:
  rule-source-ext-data-map:
    #å•ç‚¹æ¨¡å¼é…ç½®å¦‚ä¸‹ä¸¤é¡¹
    host: 127.0.0.1
    port: 6379
    #å“¨å…µæ¨¡å¼é…ç½®å¦‚ä¸‹ä¸‰é¡¹
    redisMode: sentinel
    masterName: mymaster
    sentinelAddress: [127.0.0.1:26389, 127.0.0.1:26379]
    #å¦‚æœä½ æ²¡æœ‰ç”¨æˆ·åæˆ–å¯†ç å¯ä»¥ä¸é…ç½®
    username: root
    password: 123456
    mode: poll
    pollingInterval: 60
    pollingStartTime: 60
    chainDataBase: 1
    chainKey: chainKey
    #å¦‚æœä½ æ²¡æœ‰è„šæœ¬ç»„ä»¶ï¼Œä»¥ä¸‹å¯ä»¥ä¸é…ç½®
    scriptDataBase: 1
    scriptKey: scriptKey
```

  </code-block>
  <code-block title="Propertiesé£æ ¼é…ç½®">

```properties
liteflow.rule-source-ext-data={\
      \# å•ç‚¹æ¨¡å¼é…ç½®å¦‚ä¸‹ä¸¤é¡¹\
      "host":"localhost",\
      "port":6379,\
      \# å“¨å…µæ¨¡å¼é…ç½®å¦‚ä¸‹ä¸‰é¡¹\
      "redisMode":"sentinel",\
      "masterName":"mymaster",\
      "sentinelAddress":["127.0.0.1:26389","127.0.0.1:26379"],\
      "username":"root",\
      "password":"123456",\
      "mode":"poll",\
      "pollingInterval":60,\
      "pollingStartTime":60,\
      "chainDataBase":1,\
      "chainKey":"chainKey",\
      "scriptDataBase":1,\
      "scriptKey":"scriptKey"\
}
```
  </code-block>

</code-group>



### è®¢é˜…æ¨¡å¼

<code-group>
  <code-block title="Yamlé£æ ¼é…ç½®" active>

```yaml
liteflow:
  rule-source-ext-data-map:
    #å•ç‚¹æ¨¡å¼é…ç½®å¦‚ä¸‹ä¸¤é¡¹
    host: 127.0.0.1
    port: 6379
    #å“¨å…µæ¨¡å¼é…ç½®å¦‚ä¸‹ä¸‰é¡¹
    redisMode: sentinel
    masterName: mymaster
    sentinelAddress: [127.0.0.1:26389, 127.0.0.1:26379]
    #å¦‚æœä½ æ²¡æœ‰ç”¨æˆ·åæˆ–å¯†ç å¯ä»¥ä¸é…ç½®
    username: root
    password: 123456
    mode: sub
    chainDataBase: 1
    chainKey: chainKey
    #å¦‚æœä½ æ²¡æœ‰è„šæœ¬ç»„ä»¶ï¼Œä»¥ä¸‹å¯ä»¥ä¸é…ç½®
    scriptDataBase: 1
    scriptKey: scriptKey
```

  </code-block>
  <code-block title="Propertiesé£æ ¼é…ç½®">

```properties
liteflow.rule-source-ext-data={\
      \# å•ç‚¹æ¨¡å¼é…ç½®å¦‚ä¸‹ä¸¤é¡¹\
      "host":"localhost",\
      "port":6379,\
      \# å“¨å…µæ¨¡å¼é…ç½®å¦‚ä¸‹ä¸‰é¡¹\
      "redisMode":"sentinel",\
      "masterName":"mymaster",\
      "sentinelAddress":["127.0.0.1:26389","127.0.0.1:26379"],\
      "username":"root",\
      "password":"123456",\
      "mode":"sub",\
      "chainDataBase":1,\
      "chainKey":"chainKey",\
      "scriptDataBase":1,\
      "scriptKey":"scriptKey"\
}
```
  </code-block>

</code-group>


## é…ç½®è¯´æ˜

| é…ç½®é¡¹             | è¯´æ˜                                    |
|-----------------|---------------------------------------|
| redisMode       | Redisæ¨¡å¼ï¼Œsingleä¸ºå•ç‚¹ï¼Œsentinelä¸ºå“¨å…µï¼Œé»˜è®¤ä¸ºå•ç‚¹   |
| host            | å•ç‚¹æ¨¡å¼Redisè¿æ¥IPåœ°å€                       |
| port            | å•ç‚¹æ¨¡å¼Redisè¿æ¥ç«¯å£å·                        |
| masterName      | å“¨å…µæ¨¡å¼ä¸»èŠ‚ç‚¹å                              |
| sentinelAddress | å“¨å…µæ¨¡å¼å“¨å…µèŠ‚ç‚¹è¿æ¥åœ°å€ ip:port                  |
| username        | Redisçš„ç”¨æˆ·å (Redis 6.0åŠä»¥ä¸Š)              |
| password        | Redisçš„å¯†ç                               |
| mode      | è§„åˆ™åˆ·æ–°æ¨¡å¼ï¼Œpollä¸ºè½®è¯¢ï¼Œsub/subscribeä¸ºè®¢é˜…ï¼Œé»˜è®¤ä¸ºè½®è¯¢ |
| chainDataBase        | è§„åˆ™æ•°æ®çš„æ•°æ®åº“å·                             |
| chainKey     | è§„åˆ™æ•°æ®çš„Redis keyå                       |
| scriptDataBase | è„šæœ¬ç»„ä»¶çš„æ•°æ®åº“å·                             |
| scriptKey        | è„šæœ¬ç»„ä»¶çš„Redis keyå                       |
| pollingInterval | è½®è¯¢æ—¶é—´é—´éš”(s)ï¼Œé»˜è®¤ä¸º60s                      |
| pollingStartTime        | è§„åˆ™é…ç½®åé¦–æ¬¡è½®è¯¢çš„èµ·å§‹æ—¶é—´(s)ï¼Œé»˜è®¤ä¸º60s              |


## å­˜å‚¨æ•°æ®è¯´æ˜

### è½®è¯¢æ¨¡å¼

:::tip

åœ¨è½®è¯¢æ¨¡å¼ä¸­ï¼Œè§„åˆ™å’Œè„šæœ¬æ•°æ®å‡ä»¥Redis hashç»“æ„å­˜å‚¨ï¼Œé…ç½®é¡¹`chainKey`å’Œ`scriptKey`å³ä¸ºè¯¥hashçš„åå­—ã€‚

:::

å¯¹äºè§„åˆ™æ¥è¯´ï¼Œä½ åœ¨Redisä¸­éœ€è¦ä¸ºè§„åˆ™å•ç‹¬åˆ›å»ºä¸€ä¸ªHashç±»å‹çš„æ•°æ®ï¼Œè¿™ä¸ªhashå†…çš„æ¯ä¸ªé”®å€¼å¯¹å°±æ˜¯ä¸€ä¸ªè§„åˆ™ï¼Œ**hashå†…çš„fieldä¸ºchainIdï¼Œvalueä¸ºå•çº¯çš„ELï¼ˆ`THEN(a,b,c)`ï¼‰**ã€‚

å‡è®¾ä½ çš„è§„åˆ™hashæ•°æ®é”®åä¸º:`chains`ï¼Œé‚£ä¹ˆé…ç½®å½¢å¼æ ·ä¾‹å¦‚ä¸‹ï¼š


| Redis HashKeyï¼šchains |                              |
|----------------------| ---------------------------- |
| chain1               | THEN(a, b, c);               |
| chain2               | IF(x, b).ELIF(y, c).ELSE(d); |

å¯¹äºè„šæœ¬æ¥è¯´ï¼Œhashä¸­çš„fieldæœ‰å›ºå®šæ ¼å¼ï¼š`è„šæœ¬ç»„ä»¶ID:è„šæœ¬ç±»å‹:è„šæœ¬åç§°[:è„šæœ¬è¯­è¨€]`ï¼Œvalueä¸ºè„šæœ¬æ•°æ®ã€‚

å‡è®¾ä½ çš„è„šæœ¬hashæ•°æ®é”®åä¸ºï¼š`scripts`ï¼Œé‚£ä¹ˆé…ç½®å½¢å¼æ ·ä¾‹å¦‚ä¸‹ï¼š

| Redis HashKeyï¼šscripts |                                              |
|-----------------------|----------------------------------------------|
| s1:script:è„šæœ¬ç»„ä»¶1       | defaultContext.setData("s1","hello")         |
| s2:script:è„šæœ¬ç»„ä»¶2:js    | defaultContext.setData("s2","hello")         |
| s3:if_script:è„šæœ¬ç»„ä»¶3    | if(a > 100){return true;}else{return false;} |

å…³äºè„šæœ¬ç±»å‹ï¼Œå¯ä»¥å‚ç…§[å®šä¹‰è„šæœ¬ç»„ä»¶](/pages/81d53c/)è¿™ä¸€ç« èŠ‚ã€‚

<br>

### è®¢é˜…æ¨¡å¼

:::tip

åœ¨è®¢é˜…æ¨¡å¼ä¸­ï¼Œè§„åˆ™å’Œè„šæœ¬æ•°æ®å‡ä»¥Redisson RMapCacheç»“æ„å­˜å‚¨ï¼Œé…ç½®é¡¹`chainKey`å’Œ`scriptKey`å³ä¸ºè¯¥RMapCacheçš„åå­—ã€‚

:::

å¯¹äºè§„åˆ™æ¥è¯´ï¼Œä½ éœ€è¦ä½¿ç”¨Redissonå®¢æˆ·ç«¯ï¼Œä¸ºè§„åˆ™å•ç‹¬åˆ›å»ºä¸€ä¸ªRMapCacheç±»å‹çš„æ•°æ®ï¼Œè¿™ä¸ªç»“æ„å†…çš„æ¯ä¸ªé”®å€¼å¯¹å°±æ˜¯ä¸€ä¸ªè§„åˆ™ï¼Œ**RMapCacheå†…çš„keyä¸ºchainIdï¼Œvalueä¸ºå•çº¯çš„ELï¼ˆ`THEN(a,b,c)`ï¼‰**ã€‚

å‡è®¾ä½ çš„è§„åˆ™RMapCacheæ•°æ®é”®åä¸º:`chains`ï¼Œé‚£ä¹ˆåˆ©ç”¨Redissonå®¢æˆ·ç«¯çš„æ•°æ®æ“ä½œå¦‚ä¸‹ï¼š


```java
RMapCache<String, String> chainKey = redissonClient.getMapCache("chains");
chains.put("chain1", "THEN(a, b, c);");
chains.put("chain2", "IF(x, b).ELIF(y, c).ELSE(d);");
```

å¯¹äºè„šæœ¬æ¥è¯´ï¼ŒRMapCacheä¸­çš„keyæœ‰å›ºå®šæ ¼å¼ï¼š`è„šæœ¬ç»„ä»¶ID:è„šæœ¬ç±»å‹:è„šæœ¬åç§°[:è„šæœ¬è¯­è¨€]`ï¼Œvalueä¸ºè„šæœ¬æ•°æ®ã€‚

å‡è®¾ä½ çš„è„šæœ¬RMapCacheæ•°æ®é”®åä¸º:`scripts`ï¼Œé‚£ä¹ˆåˆ©ç”¨Redissonå®¢æˆ·ç«¯çš„æ•°æ®æ“ä½œå¦‚ä¸‹ï¼š

```java
RMapCache<String, String> scriptKey = redissonClient.getMapCache("scripts");
scripts.put("s1:script:è„šæœ¬ç»„ä»¶1", "defaultContext.setData(\"test1\",\"hello\");");
scripts.put("s2:script:è„šæœ¬ç»„ä»¶2:js", "defaultContext.setData(\"test2\",\"hello\");");
```

å…³äºè„šæœ¬ç±»å‹ï¼Œå¯ä»¥å‚ç…§[å®šä¹‰è„šæœ¬ç»„ä»¶](/pages/81d53c/)è¿™ä¸€ç« èŠ‚ã€‚


## è‡ªåŠ¨åˆ·æ–°

ä½¿ç”¨äº†æ­¤Redisé…ç½®æºæ’ä»¶ï¼Œå‡¡æ˜¯åœ¨é…ç½®çš„Redisé”®å†…çš„æ•°æ®æ”¹åŠ¨ï¼Œä¼šè‡ªåŠ¨æ¨é€åˆ°ä¸šåŠ¡ç³»ç»Ÿï¼ˆè½®è¯¢æ¨¡å¼ä¼šä¾æ®è®¾å®šçš„è½®è¯¢å‚æ•°å®šæœŸæ¨é€ï¼‰ï¼Œä½ æ— éœ€åšä»»ä½•äº‹æƒ…ã€‚


## å°ä¾‹å­

ä¸ºäº†è®©å¤§å®¶èƒ½ç®€å•ä¸Šæ‰‹Redisè§„åˆ™æ–‡ä»¶çš„é…ç½®å’Œè¿è¡Œï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå°demoï¼Œå¤§å®¶å¯ä»¥æ‹‰åˆ°æœ¬åœ°æ¥è¿è¡Œï¼Œéœ€è¦ä½ æ›¿æ¢Redisçš„é…ç½®ä¿¡æ¯ã€‚

è¿è¡Œé¡¹ç›®å‰ï¼Œå…ˆè¯»é¡¹ç›®é‡Œçš„`readme.txt`æ–‡ä»¶ã€‚

> https://github.com/bryan31/liteflow-ext-rule-demo